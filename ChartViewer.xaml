<UserControl x:Class="Log_Analyzer_App.ChartViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             xmlns:local="clr-namespace:Log_Analyzer_App"
             mc:Ignorable="d" 
             d:DesignHeight="830" d:DesignWidth="1020">
    <UserControl.Resources>
        <!-- Style to make the legend item look like a togglable button -->
        <Style x:Key="LegendToggleButtonStyle" TargetType="Button" BasedOn="{StaticResource MaterialDesignFlatButton}">
            <Setter Property="Margin" Value="5 0"/>
            <Setter Property="Padding" Value="5 3"/>
            <Setter Property="Height" Value="Auto"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="materialDesign:ButtonAssist.CornerRadius" Value="5"/>
            <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}"/>
            <Setter Property="Opacity" Value="1"/>
            <Style.Triggers>
                <!-- When the item is not visible (IsVisible=False), dim it visually -->
                <DataTrigger Binding="{Binding IsVisible}" Value="False">
                    <Setter Property="Opacity" Value="0.4"/>
                    <Setter Property="ToolTip" Value="Click to show"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsVisible}" Value="True">
                    <Setter Property="ToolTip" Value="Click to hide"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <!-- FIX: Applied TextElement.Foreground to the root container Grid -->
    <Grid Background="{DynamicResource MaterialDesignPaper}" Margin="20" TextElement.Foreground="{DynamicResource MaterialDesignBody}">
        <!-- Wrap the main content StackPanel in a ScrollViewer -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20">
                <TextBlock Text="Log Event Distribution Analysis" FontSize="32" FontWeight="Bold" Margin="0 0 0 10" HorizontalAlignment="Center" Foreground="{DynamicResource MaterialDesignBody}"/>

                <!-- Chart Filter Controls -->
                <materialDesign:Card UniformCornerRadius="10" Padding="15" Margin="0 0 0 20">
                    <StackPanel>
                        <Grid Margin="0 0 0 15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="Chart Filtering" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Left" Foreground="{DynamicResource MaterialDesignBody}"/>

                            <!-- Displayed Log Lines Count Display -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="10 0 0 0">
                                <TextBlock Text="Displayed Log Lines:" Opacity="0.8" VerticalAlignment="Center" Margin="0 0 5 0"/>
                                <materialDesign:Badged Content="{Binding FilteredLogCount}" 
                                                       BadgeBackground="{DynamicResource MaterialDesignLightTealAccentBrush}" 
                                                       BadgeForeground="White"
                                                       VerticalAlignment="Center"/>
                            </StackPanel>
                        </Grid>

                        <!-- Filter Inputs and Apply Button -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Chart Grouping Dropdown (Left Column) -->
                            <ComboBox materialDesign:HintAssist.Hint="Group Chart Data by Column"
                                      ItemsSource="{Binding AvailableStatsFields}"
                                      SelectedItem="{Binding SelectedStatsField, Mode=TwoWay}"
                                      Grid.Column="0"
                                      Margin="0 0 10 0"
                                      IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>

                            <!-- Date Pickers (Center Column) -->
                            <StackPanel Grid.Column="1" Margin="5 0" IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="5"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Start Date -->
                                    <DatePicker Grid.Column="0" 
                                                materialDesign:HintAssist.Hint="Start Date"
                                                SelectedDate="{Binding ChartStartDate, Mode=TwoWay}"/>

                                    <TextBlock Grid.Column="1" Text="-" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5"/>

                                    <!-- End Date -->
                                    <DatePicker Grid.Column="2" 
                                                materialDesign:HintAssist.Hint=" End Date"
                                                SelectedDate="{Binding ChartEndDate, Mode=TwoWay}"/>
                                </Grid>
                            </StackPanel>

                            <!-- Time Pickers (Right Column) -->
                            <StackPanel Grid.Column="2" Margin="10 0" IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="5"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Start Time -->
                                    <TextBox Grid.Column="0" 
                                             materialDesign:HintAssist.Hint="Start Time (HH:MM)"
                                             Text="{Binding ChartStartTimeText}"/>

                                    <TextBlock Grid.Column="1" Text="-" VerticalAlignment="Center" HorizontalAlignment="Center" Opacity="0.5"/>

                                    <!-- End Time -->
                                    <TextBox Grid.Column="2" 
                                             materialDesign:HintAssist.Hint=" End Time (HH:MM)"
                                             Text="{Binding ChartEndTimeText}"/>
                                </Grid>
                            </StackPanel>

                            <!-- FIX: Changed style to the standard MaterialDesignRaisedButton and applied an accent background -->
                            <Button Grid.Column="3"
                                    Content="{Binding IsCalculating, Converter={StaticResource BooleanToContentConverter}, ConverterParameter='APPLY FILTER|CALCULATING...'}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Background="{DynamicResource SecondaryHueMidBrush}"
                                    Foreground="{DynamicResource MaterialDesignBody}"
                                    materialDesign:ButtonAssist.CornerRadius="5"
                                    Click="ApplyChartFilter_Click"
                                    Margin="10 0 0 0"
                                    VerticalAlignment="Center"
                                    IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>
                        </Grid>
                    </StackPanel>
                </materialDesign:Card>
                <!-- END Chart Filter Controls -->

                <!-- Main Chart Area (Two Columns: Raw Counts & Percentage Distribution) -->
                <materialDesign:Card UniformCornerRadius="10" Padding="15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- NEW: Overlay for the entire 2-column chart area -->
                        <Grid Grid.ColumnSpan="2" 
                              Background="{DynamicResource MaterialDesignPaper}" 
                              Opacity="0.8"
                              Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                                             IsIndeterminate="True" 
                                             Width="50" Height="50" 
                                             Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                <TextBlock Text="Calculating Data..." 
                                           Margin="10" 
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource MaterialDesignBody}"/>
                            </StackPanel>
                        </Grid>

                        <!-- Left Column: Bar Chart (Raw Counts) -->
                        <Grid Grid.Column="0" Margin="0 0 10 0">
                            <!-- Bar Chart -->
                            <StackPanel>
                                <TextBlock Text="Event Count Breakdown (Raw Counts)" FontWeight="SemiBold" Margin="0 0 0 10" HorizontalAlignment="Center" FontSize="18"/>
                                <lvc:CartesianChart Series="{Binding SeriesCollection}" LegendLocation="None" 
                                                    Hoverable="True"
                                                    Height="500">
                                    <!-- Height reduced slightly to make room for the custom legend -->

                                    <lvc:CartesianChart.AxisX>
                                        <lvc:Axis Title="{Binding SelectedStatsField}" ShowLabels="True"/>
                                    </lvc:CartesianChart.AxisX>

                                    <lvc:CartesianChart.AxisY>
                                        <lvc:Axis Title="Count" LabelFormatter="{Binding Formatter}"/>
                                    </lvc:CartesianChart.AxisY>

                                </lvc:CartesianChart>

                                <!-- NEW: Custom Toggleable Legend -->
                                <materialDesign:Card UniformCornerRadius="8" Padding="10" Margin="0 10 0 0" Background="{DynamicResource MaterialDesignLightBackground}">
                                    <StackPanel>
                                        <TextBlock Text="Bar Visibility" FontWeight="SemiBold" Opacity="0.8" Margin="0 0 0 5"/>
                                        <ScrollViewer VerticalScrollBarVisibility="Disabled" HorizontalScrollBarVisibility="Auto" MaxHeight="50">
                                            <ItemsControl ItemsSource="{Binding BarChartLegendItems}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel HorizontalAlignment="Center"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type local:ChartLegendItem}">
                                                        <!-- Clickable Button for each Legend Item -->
                                                        <Button CommandParameter="{Binding}" 
                                                                Style="{StaticResource LegendToggleButtonStyle}" 
                                                                Click="ToggleSeriesVisibility">
                                                            <StackPanel Orientation="Horizontal">
                                                                <!-- Colored Circle Icon -->
                                                                <materialDesign:PackIcon Kind="CircleSmall" Width="12" Height="12" Margin="0 0 5 0" 
                                                                                         Foreground="{Binding Color}" VerticalAlignment="Center"/>
                                                                <!-- Key/Title -->
                                                                <TextBlock Text="{Binding Key}" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                                            </StackPanel>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>
                                </materialDesign:Card>
                                <!-- END NEW: Custom Toggleable Legend -->

                            </StackPanel>
                        </Grid>

                        <!-- Right Column: Pie Chart (Proportional Breakdown) & Options -->
                        <Grid Grid.Column="1" Margin="10 0 0 0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Pie Chart -->
                            <StackPanel Grid.Row="0">
                                <TextBlock Text="Percentage Distribution" FontWeight="SemiBold" Margin="0 0 0 10" HorizontalAlignment="Center" FontSize="18"/>
                                <lvc:PieChart Series="{Binding PieSeriesCollection}" 
                                              LegendLocation="Top" 
                                              Hoverable="True"
                                              InnerRadius="50"
                                              Height="450">
                                    <!-- Height increased to match the Bar Chart -->
                                </lvc:PieChart>
                            </StackPanel>

                            <!-- Options Box for Pie Chart -->
                            <materialDesign:Card Grid.Row="1" UniformCornerRadius="8" Padding="15" Margin="0 15 0 0" Background="{DynamicResource MaterialDesignLightBackground}">
                                <StackPanel>
                                    <TextBlock Text="Pie Chart Options" FontWeight="Bold" Margin="0 0 0 10"/>

                                    <!-- Label Display Style -->
                                    <TextBlock Text="Slice Label Content:" Opacity="0.8" Margin="0 0 0 5"/>
                                    <StackPanel Orientation="Horizontal" Margin="0 0 0 10">
                                        <RadioButton x:Name="PercentRadio" Content="Percentage Only" IsChecked="True" GroupName="PieLabel" Margin="0 0 15 0" Foreground="{DynamicResource MaterialDesignBody}" Checked="PieLabelMode_Changed" IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>
                                        <RadioButton x:Name="RawCountRadio" Content="Raw Count" GroupName="PieLabel" Foreground="{DynamicResource MaterialDesignBody}" Checked="PieLabelMode_Changed" IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>
                                    </StackPanel>

                                    <!-- Minimum Threshold Slider -->
                                    <TextBlock Text="Minimum Slice Percentage (0%)" x:Name="SlicePercentageText" Opacity="0.8" Margin="0 5 0 5"/>
                                    <Slider x:Name="SliceThresholdSlider" Value="0" Minimum="0" Maximum="10" TickFrequency="1" IsSnapToTickEnabled="True" ValueChanged="SliceThresholdSlider_ValueChanged" IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>
                                </StackPanel>
                            </materialDesign:Card>
                        </Grid>
                    </Grid>
                </materialDesign:Card>

                <!-- NEW: Time Series Chart Area (Full Width) -->
                <materialDesign:Card UniformCornerRadius="10" Padding="15" Margin="0 20 0 0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0">
                            <TextBlock Text="Event Trend Over Time" FontSize="18" FontWeight="SemiBold" Margin="0 0 0 15" HorizontalAlignment="Center" Foreground="{DynamicResource MaterialDesignBody}"/>

                            <!-- Dropdown for Time Range Selection -->
                            <ComboBox materialDesign:HintAssist.Hint="Group by Time Range"
                                      ItemsSource="{Binding TimeRangeTypes}"
                                      SelectedItem="{Binding SelectedTimeRange, Mode=TwoWay}"
                                      HorizontalAlignment="Center"
                                      Width="200"
                                      Margin="0 0 0 20"
                                      IsEnabled="{Binding IsCalculating, Converter={StaticResource InverseBooleanConverter}}"/>
                        </StackPanel>

                        <!-- NEW: Time Series Chart Area Grid -->
                        <Grid Grid.Row="1">
                            <!-- Time Series Bar Chart -->
                            <lvc:CartesianChart Series="{Binding TimeSeriesCollection}" 
                                                LegendLocation="None" 
                                                Hoverable="True"
                                                Height="400">

                                <lvc:CartesianChart.AxisX>
                                    <!-- The title will be dynamic based on the SelectedTimeRange -->
                                    <lvc:Axis Title="{Binding SelectedTimeRange}" ShowLabels="True" Labels="{Binding TimeLabels}"/>
                                </lvc:CartesianChart.AxisX>

                                <lvc:CartesianChart.AxisY>
                                    <lvc:Axis Title="Event Count" LabelFormatter="{Binding Formatter}"/>
                                </lvc:CartesianChart.AxisY>

                            </lvc:CartesianChart>

                            <!-- NEW: Overlay for the Time Series Chart Area -->
                            <Grid Background="{DynamicResource MaterialDesignPaper}" 
                                  Opacity="0.8"
                                  Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                                             IsIndeterminate="True" 
                                             Width="50" Height="50" 
                                             HorizontalAlignment="Center" VerticalAlignment="Center"
                                             Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                            </Grid>
                        </Grid>
                    </Grid>
                </materialDesign:Card>
                <!-- END NEW: Time Series Chart Area -->

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>