<UserControl x:Class="Log_Analyzer_App.ChatAssistantView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:local="clr-namespace:Log_Analyzer_App"
             mc:Ignorable="d" 
             d:DesignHeight="830" d:DesignWidth="1020">

    <Grid Margin="20" TextElement.Foreground="{DynamicResource MaterialDesignBody}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Chat Assistant &amp; Query Tool" FontSize="28" FontWeight="Bold" Margin="0 0 0 20"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Data Viewer (for loaded LogDataStore data) -->
            <StackPanel Grid.Column="0" Margin="0 0 20 0">
                <materialDesign:Card UniformCornerRadius="10" Padding="15" Margin="0 0 0 15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" VerticalAlignment="Center">
                            <TextBlock Text="Loaded Data Source" FontWeight="SemiBold" Opacity="0.8"/>
                            <!-- Bind to the updated LoadedFilePath property -->
                            <TextBlock Text="{Binding LoadedFilePath}" x:Name="FilePathTextBlock" TextWrapping="Wrap" Opacity="0.7"/>
                        </StackPanel>

                        <!-- Display log entry count -->
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding LogEntries.Count, StringFormat='Log Entries: {0:N0}'}" 
                                   VerticalAlignment="Center" 
                                   FontWeight="SemiBold"
                                   Margin="10 0 0 0"
                                   Visibility="{Binding IsDataLoaded, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>
                </materialDesign:Card>

                <materialDesign:Card UniformCornerRadius="10">
                    <DataGrid x:Name="JsonDataGrid"
                              AutoGenerateColumns="False" 
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              Height="600"
                              materialDesign:DataGridAssist.CellPadding="10"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="10 10"
                              Margin="15"                   
                              ItemsSource="{Binding LogEntries}">
                    </DataGrid>
                </materialDesign:Card>
            </StackPanel>

            <!-- Right Panel: Chat Interface -->
            <materialDesign:Card Grid.Column="1" UniformCornerRadius="10" Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Chat History List -->
                    <ListView Grid.Row="0"
                              x:Name="ChatListView"
                              ItemsSource="{Binding ChatHistory}"
                              BorderThickness="0"
                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                              Background="Transparent">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="{x:Type ListViewItem}">
                                <Setter Property="Focusable" Value="False"/>
                                <Setter Property="Margin" Value="0 5"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="{x:Type ListViewItem}">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>

                        <ListView.ItemTemplate>
                            <DataTemplate DataType="{x:Type local:ChatMessage}">
                                <Border Padding="10"
                                        CornerRadius="10"
                                        MaxWidth="500">

                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <!-- Default: Assistant (Left, Gray background) -->
                                            <Setter Property="HorizontalAlignment" Value="Left"/>
                                            <Setter Property="Background" Value="{DynamicResource MaterialDesignBackground}"/>

                                            <Style.Triggers>
                                                <!-- Trigger: User (Right, Primary/Blue background) -->
                                                <DataTrigger Binding="{Binding Sender}" Value="User">
                                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                                    <Setter Property="Background" Value="{StaticResource PrimaryHueMidBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>

                                    <TextBlock Text="{Binding Text}" 
                                               TextWrapping="Wrap">

                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <!-- Base color is bound to TextColor from the C# code -->
                                                <Setter Property="Foreground" Value="{Binding TextColor}"/>

                                                <Style.Triggers>
                                                    <!-- Override TextColor if it's a user message (to contrast with blue background) -->
                                                    <DataTrigger Binding="{Binding Sender}" Value="User">
                                                        <Setter Property="Foreground" Value="{StaticResource MaterialDesignPaper}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Input and Send Button -->
                    <Grid Grid.Row="1" Margin="0 15 0 0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0"
                                 materialDesign:HintAssist.Hint="Ask a question about the loaded data..."
                                 Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                                 Text="{Binding CurrentQueryText, UpdateSourceTrigger=PropertyChanged}"
                                 
                                 IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"/>

                        <Button Grid.Column="1"
                                Margin="10 0 0 0"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                Background="{DynamicResource PrimaryHueMidBrush}"
                                materialDesign:ButtonAssist.CornerRadius="5"
                                Click="AnalyzeData_Click"
                                
                                IsEnabled="{Binding CanSendMessage}">
                            <!-- Content is the PackIcon -->
                            <materialDesign:PackIcon Kind="Send" VerticalAlignment="Center" Foreground="{StaticResource MaterialDesignPaper}"/>
                        </Button>
                    </Grid>
                </Grid>
            </materialDesign:Card>
        </Grid>
    </Grid>
</UserControl>