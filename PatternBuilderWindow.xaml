<Window x:Class="Log_Analyzer_App.PatternBuilderWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:local="clr-namespace:Log_Analyzer_App"
        mc:Ignorable="d"
        Title="Custom Parse Template Builder" 
        Height="600" Width="800" 
        WindowStartupLocation="CenterScreen"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="{x:Null}"
        DataContext="{Binding RelativeSource={RelativeSource Self}}">

    <materialDesign:Card UniformCornerRadius="15" Margin="10" Padding="20" Background="{DynamicResource MaterialDesignPaper}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Title -->
                <RowDefinition Height="Auto"/>
                <!-- Log Line Preview -->
                <RowDefinition Height="Auto"/>
                <!-- Parse Template Input & Test Button -->
                <RowDefinition Height="*"/>
                <!-- Match Preview & Help -->
                <RowDefinition Height="Auto"/>
                <!-- Action Buttons -->
            </Grid.RowDefinitions>

            <!-- Title -->
            <TextBlock Grid.Row="0" Text="Custom Log Pattern Configuration" FontSize="24" FontWeight="Bold" Margin="0 0 0 15" Foreground="{DynamicResource MaterialDesignBody}"/>

            <!-- 1. Parse Template Input and Test -->
            <StackPanel Grid.Row="2" Margin="0 0 0 15">
                <!-- Text updated to refer to "Parse Template" -->
                <TextBlock Text="1. Enter Your Custom Parse Template" FontWeight="SemiBold" Opacity="0.8" Margin="0 0 0 5" Foreground="{DynamicResource MaterialDesignBody}"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Property name in binding is kept as CustomRegex for backward compatibility with C# property name, but mentally it's the Parse Template -->
                    <TextBox x:Name="ParsePatternTextBox"
                             Text="{Binding CustomRegex, UpdateSourceTrigger=PropertyChanged}"
                             Grid.Column="0"
                             materialDesign:HintAssist.Hint="Example: [{Timestamp}] {Level}: {Message}"
                             TextWrapping="Wrap"
                             FontFamily="Consolas"
                             Margin="0 0 10 0"
                             KeyUp="ParsePatternTextBox_KeyUp"
                             Foreground="{DynamicResource MaterialDesignBody}"/>

                    <Button Content="TEST PATTERN" 
                            Grid.Column="1" 
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            materialDesign:ButtonAssist.CornerRadius="5"
                            Click="TestPattern_Click"/>
                </Grid>

                <TextBox x:Name="PatternDescriptionTextBox"
                         Text="{Binding PatternDescription, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="Enter a brief description for this pattern (e.g., Simple Bracketed Log Format)"
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                         Margin="0 15 0 0"
                         Foreground="{DynamicResource MaterialDesignBody}"/>
            </StackPanel>

            <!-- 2. Match Preview & Help -->
            <Grid Grid.Row="3">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Match Preview (Left) -->
                <materialDesign:Card Grid.Column="0" UniformCornerRadius="8" Padding="15" Margin="0 0 10 0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <!-- Text updated to refer to "Field Preview" -->
                            <TextBlock Text="2. Real-Time Field Preview" FontWeight="Bold" Margin="0 0 0 10" Foreground="{DynamicResource MaterialDesignBody}"/>
                            <TextBlock x:Name="MatchStatusTextBlock" Text="Status: Waiting for test..." Margin="0 0 0 10" Foreground="Gray"/>

                            <!-- Dynamic Field Naming Section -->
                            <TextBlock Text="Field Naming:" FontWeight="SemiBold" Opacity="0.8" Margin="0 5 0 5" 
                                       ToolTip="Give each field a descriptive column name." Foreground="{DynamicResource MaterialDesignBody}"/>

                            <!-- ItemsControl to dynamically generate naming inputs for each group -->
                            <ItemsControl ItemsSource="{Binding FieldDefinitions}" Margin="0 0 0 15">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0 0 0 5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Field Index/Placeholder Name -->
                                            <TextBlock Grid.Column="0" Text="{Binding PlaceholderName, StringFormat='Field: {0}:'}" FontWeight="SemiBold" Margin="0 0 10 0" VerticalAlignment="Center" Foreground="{DynamicResource MaterialDesignBody}"/>
                                            <!-- Preview Value (Now generic text) -->
                                            <TextBlock Grid.Column="1" Text="{Binding PreviewValue, StringFormat='&quot;{0}&quot;'}" Opacity="0.7" VerticalAlignment="Center" FontFamily="Consolas" TextTrimming="CharacterEllipsis" MaxWidth="150" Foreground="{DynamicResource MaterialDesignBody}"/>

                                            <!-- Name Input -->
                                            <!-- Note: FieldName property is used for the actual column name and is bound here -->
                                            <TextBox Grid.Column="2" 
                                                     Text="{Binding FieldName, UpdateSourceTrigger=PropertyChanged}"
                                                     materialDesign:HintAssist.Hint="Column Name (e.g., Timestamp, Level)"
                                                     Margin="10 0 0 0"
                                                     VerticalAlignment="Center"
                                                     Foreground="{DynamicResource MaterialDesignBody}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <!-- End Dynamic Field Naming Section -->

                        </StackPanel>
                    </ScrollViewer>
                </materialDesign:Card>

                <!-- Parse Template Help (Right) -->
                <materialDesign:Card Grid.Column="1" UniformCornerRadius="8" Padding="15" Margin="10 0 0 0" Background="{DynamicResource MaterialDesignLightBackground}">
                    <StackPanel>
                        <TextBlock Text="Parse Template Quick Help" FontWeight="Bold" Margin="0 0 0 10" Foreground="{DynamicResource MaterialDesignBody}"/>
                        <!-- Updated help text -->
                        <TextBlock Text="Define fields using curly braces: {field_name}. All text outside the braces must exactly match your log line." TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0 0 0 10" Foreground="{DynamicResource MaterialDesignBody}"/>

                        <TextBlock Text="Date Fields:" FontWeight="SemiBold" Margin="0 0 0 5" Foreground="{DynamicResource MaterialDesignBody}"/>
                        <TextBlock Text="Ensure the date field in the log line is capture properly so that date and time features work as intended." TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0 0 0 10" Foreground="{DynamicResource MaterialDesignBody}"/>
                    </StackPanel>
                </materialDesign:Card>
            </Grid>

            <!-- 4. Action Buttons -->
            <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0 20 0 0">
                <Button Content="CANCEL" 
                        Style="{StaticResource MaterialDesignFlatButton}" 
                        Margin="0 0 10 0"
                        Click="Cancel_Click"/>

                <Button Content="3. SAVE AND USE PATTERN" 
                        x:Name="SaveButton"
                        Style="{StaticResource MaterialDesignRaisedButton}"
                        materialDesign:ButtonAssist.CornerRadius="5"
                        Background="{DynamicResource PrimaryHueMidBrush}"
                        IsEnabled="False"
                        Click="SaveAndUsePattern_Click"
                        Foreground="{DynamicResource MaterialDesignBody}"/>
            </StackPanel>
        </Grid>
    </materialDesign:Card>
</Window>